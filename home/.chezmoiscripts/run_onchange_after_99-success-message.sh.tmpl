#!/bin/bash
set -euo pipefail

# This script runs on all platforms as the final step

# Colors for output (ANSI escape codes work on most modern terminals)
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

{{- /* Detect if running in a VM */ -}}
{{- $isVM := false -}}
{{- if eq .chezmoi.os "darwin" -}}
  {{- if contains "VirtualMac" (output "sh" "-c" "system_profiler SPHardwareDataType 2>/dev/null | grep 'Model Identifier' | cut -d: -f2 | xargs || echo ''") -}}
    {{- $isVM = true -}}
  {{- else if contains "QEMU" (output "sh" "-c" "ioreg -l 2>/dev/null | grep -i 'manufacturer.*QEMU' | head -1 || echo ''") -}}
    {{- $isVM = true -}}
  {{- else if contains "AppleVirtualPlatform" (output "sh" "-c" "ioreg -l 2>/dev/null | grep 'IOProviderClass.*AppleVirtualPlatform' | head -1 || echo ''") -}}
    {{- $isVM = true -}}
  {{- else if contains "VirtualMac" (output "sh" "-c" "nvram 4D1FDA02-38C7-4A6A-9CC6-4BCCA8B30102:boot-rom-version 2>/dev/null || echo ''") -}}
    {{- $isVM = true -}}
  {{- end -}}
{{- end -}}

echo ""
echo "════════════════════════════════════════════════════════════════"
echo ""
echo -e "   ${GREEN}✨ Chezmoi Setup Complete! ✨${NC}"
echo ""
echo "════════════════════════════════════════════════════════════════"
echo ""
echo -e "${CYAN}System Information:${NC}"
echo -e "  • Platform: {{ .chezmoi.os }}"
echo -e "  • Hostname: {{ .chezmoi.hostname }}"
echo -e "  • Username: {{ .chezmoi.username }}"
{{- if $isVM }}
echo -e "  • Environment: ${YELLOW}Virtual Machine${NC}"
{{- end }}
echo ""
echo -e "${BLUE}Configured Components:${NC}"
echo "  ✓ Shell configurations"
echo "  ✓ Development tools"
echo "  ✓ Git with SSH signing"
echo "  ✓ Terminal and editor settings"
{{- if eq .chezmoi.os "darwin" }}
echo "  ✓ macOS system preferences"
echo "  ✓ Homebrew packages"
{{- if $isVM }}
echo "  ⚠ Mac App Store apps (skipped in VM)"
{{- else }}
echo "  ✓ Mac App Store applications"
{{- end }}
{{- end }}
echo ""
echo -e "${GREEN}Next Steps:${NC}"
echo ""
echo "  1. ${CYAN}Restart your terminal${NC} or reload your shell config"
echo ""
echo "  2. ${CYAN}Set up 1Password CLI${NC} for SSH signing:"
echo "     Run: op signin"
echo ""
echo "  3. ${CYAN}Verify installation:${NC}"
echo "     git --version"
echo "     mise --version"
echo ""
echo "════════════════════════════════════════════════════════════════"
echo -e "        ${GREEN}Happy coding! 🚀${NC}  Dotfiles by @jpogran"
echo "════════════════════════════════════════════════════════════════"
echo ""