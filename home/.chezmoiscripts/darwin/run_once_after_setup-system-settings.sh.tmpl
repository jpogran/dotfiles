#!/bin/bash
set -eufo pipefail

# ============================================================================
# macOS System Preferences Configuration Script
# ============================================================================

# Close System Preferences to prevent conflicts
osascript -e 'tell application "System Preferences" to quit' 2>/dev/null || true

# ========================================================================
# General UI/UX Configuration
# ========================================================================
defaults write NSGlobalDomain AppleInterfaceStyle -string "Dark"
defaults write NSGlobalDomain AppleKeyboardUIMode -int 2
defaults write NSGlobalDomain AppleActionOnDoubleClick -string "Maximize"
defaults write NSGlobalDomain _HIHideMenuBar -bool false
defaults write NSGlobalDomain NSRecentDocumentsLimit -int 10
defaults write NSGlobalDomain AppleShowAllExtensions -bool true

# Show ~/Library folder
chflags nohidden ~/Library 2>/dev/null || true

# ========================================================================
# Keyboard Configuration
# ========================================================================
# Set US keyboard layout
keyboard_layout='<dict>
    <key>InputSourceKind</key><string>Keyboard Layout</string>
    <key>KeyboardLayout ID</key><integer>252</integer>
    <key>KeyboardLayout Name</key><string>ABC</string>
</dict>'

defaults write com.apple.HIToolbox AppleEnabledInputSources -array "$keyboard_layout"
defaults write com.apple.HIToolbox AppleSelectedInputSources -array "$keyboard_layout"
defaults write com.apple.HIToolbox AppleCurrentKeyboardLayoutInputSourceID -string "com.apple.keylayout.ABC"

# ========================================================================
# Dock Configuration
# ========================================================================
defaults write com.apple.dock autohide -bool true
defaults write com.apple.dock autohide-delay -float 0.5
defaults write com.apple.dock autohide-time-modifier -float 0.5
defaults write com.apple.dock tilesize -int 48
defaults write com.apple.dock magnification -bool true
defaults write com.apple.dock largesize -int 80
defaults write com.apple.dock orientation -string "bottom"
defaults write com.apple.dock mineffect -string "genie"
defaults write com.apple.dock minimize-to-application -bool true
defaults write com.apple.dock launchanim -bool true
defaults write com.apple.dock show-process-indicators -bool true
defaults write com.apple.dock show-recents -bool false
defaults write com.apple.dock static-only -bool false
defaults write com.apple.dock mru-spaces -bool false

# Stage Manager settings
defaults write com.apple.WindowManager StandardHideDesktopIcons -bool false
defaults write com.apple.WindowManager EnableStandardClickToShowDesktop -bool true
defaults write com.apple.WindowManager GloballyEnabled -bool false
defaults write com.apple.WindowManager StageManagerHideUnusedApplications -bool false
defaults write com.apple.WindowManager AppWindowGroupingBehavior -int 0

# ========================================================================
# Finder Configuration
# ========================================================================
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
defaults write com.apple.finder FXEnableRemoveFromICloudDriveWarning -bool true
defaults write com.apple.finder WarnOnEmptyTrash -bool true
defaults write com.apple.finder FXRemoveOldTrashItems -bool false
defaults write com.apple.finder _FXSortFoldersFirst -bool true
defaults write com.apple.finder _FXSortFoldersFirstOnDesktop -bool false
defaults write com.apple.finder FXDefaultSearchScope -string "SCev"
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"
defaults write com.apple.finder ShowPathbar -bool true
defaults write com.apple.finder ShowStatusBar -bool true

# Sidebar visibility settings
# Favorites
defaults write com.apple.sidebarlists systemitems -dict-add "ShowRecents" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowAirDrop" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowApplications" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowDesktop" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowDocuments" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowDownloads" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowMovies" -bool false
defaults write com.apple.sidebarlists systemitems -dict-add "ShowMusic" -bool false
defaults write com.apple.sidebarlists systemitems -dict-add "ShowPictures" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowHome" -bool true

# iCloud
defaults write com.apple.sidebarlists systemitems -dict-add "ShowiCloudDrive" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowShared" -bool true

# Locations
defaults write com.apple.sidebarlists systemitems -dict-add "ShowComputer" -bool false
defaults write com.apple.sidebarlists systemitems -dict-add "ShowHardDisks" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowExternalDisks" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowRemovableMedia" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowCloudStorage" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowBonjourComputers" -bool true
defaults write com.apple.sidebarlists systemitems -dict-add "ShowConnectedServers" -bool true

# Tags
defaults write com.apple.sidebarlists systemitems -dict-add "ShowRecentTags" -bool false

# ========================================================================
# Screenshot Configuration
# ========================================================================
screenshot_dir="$HOME/Pictures/screenshots"
mkdir -p "$screenshot_dir" 2>/dev/null || true

defaults write com.apple.screencapture location -string "$screenshot_dir"
defaults write com.apple.screencapture type -string "png"
defaults write com.apple.screencapture disable-shadow -bool true

# ========================================================================
# Control Center Configuration
# ========================================================================
# Control Center only (8)
defaults write com.apple.controlcenter "WiFi" -int 8
defaults write com.apple.controlcenter "Bluetooth" -int 8
defaults write com.apple.controlcenter "AirDrop" -int 8
defaults write com.apple.controlcenter "StageManager" -int 8

# Show when active (18)
defaults write com.apple.controlcenter "FocusModes" -int 18
defaults write com.apple.controlcenter "ScreenMirroring" -int 18
defaults write com.apple.controlcenter "Display" -int 18
defaults write com.apple.controlcenter "Sound" -int 18
defaults write com.apple.controlcenter "NowPlaying" -int 18

# Always show (2)
defaults write com.apple.controlcenter "AccessibilityShortcuts" -int 2
defaults write com.apple.controlcenter "Hearing" -int 2
defaults write com.apple.controlcenter "KeyboardBrightness" -int 2
defaults write com.apple.controlcenter "Battery" -int 2

# Disabled (0)
defaults write com.apple.controlcenter "MusicRecognition" -int 0
defaults write com.apple.controlcenter "UserSwitcher" -int 0

# Battery percentage
defaults write com.apple.controlcenter "BatteryShowPercentage" -bool true

# Hide specific menu bar items
defaults write com.apple.controlcenter "NSStatusItem Visible com.apple.Spotlight" -bool false
defaults write com.apple.controlcenter "NSStatusItem Visible Siri" -bool false
defaults write com.apple.controlcenter "NSStatusItem Visible com.apple.TimeMachine.TMMenuExtraHost" -bool false
defaults write com.apple.controlcenter "NSStatusItem Visible WeatherWidget" -bool false

# turn on night shift
nightlight schedule start


# disable Xcode Cloud upsell
defaults write com.apple.dt.Xcode XcodeCloudUpsellPromptEnabled -bool false

# Disable "removing from iCloud Drive" warnings
defaults write com.apple.finder FXEnableRemoveFromICloudDriveWarning -bool false


# ========================================================================
# Restart Services
# ========================================================================
services=(Finder Dock SystemUIServer ControlCenter)
for service in "${services[@]}"; do
    if pgrep -x "$service" > /dev/null 2>&1; then
        killall "$service" 2>/dev/null || true
    fi
done
