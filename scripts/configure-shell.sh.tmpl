#!/bin/bash
# Set default shell across platforms
# This script will set fish as the default shell if it's installed

# Determine the path to fish
FISH_PATH="$(which fish 2>/dev/null)"

if [ -z "$FISH_PATH" ]; then
    echo "Fish shell not found. Please install fish first."
    exit 1
fi

echo "Fish shell found at: $FISH_PATH"

# Add fish to /etc/shells if it's not already there
if ! grep -q "^$FISH_PATH$" /etc/shells; then
    echo "Adding $FISH_PATH to /etc/shells..."
    echo "$FISH_PATH" | sudo tee -a /etc/shells
fi

# Set fish as the default shell
if [ "$SHELL" != "$FISH_PATH" ]; then
    echo "Setting fish as the default shell for {{ .data.username }}..."
    chsh -s "$FISH_PATH"
    echo "Shell changed to fish. Please log out and back in for the change to take effect."
else
    echo "Fish is already the default shell."
fi

# Setup fish configuration
echo "Setting up fish configuration..."

# Make sure the fish config directory exists
mkdir -p ~/.config/fish/conf.d
mkdir -p ~/.config/fish/functions

# Apply theme settings
cat > ~/.config/fish/conf.d/theme.fish.tmp << EOF
# Theme configuration for fish shell
# Generated by chezmoi

# Set fish theme
set -g fish_color_normal {{ .data.theme.colors.text }}
set -g fish_color_command {{ .data.theme.colors.accent }}
set -g fish_color_param {{ .data.theme.colors.text }}
set -g fish_color_redirection {{ .data.theme.colors.accent }}
set -g fish_color_comment 808080
set -g fish_color_error ff0000
set -g fish_color_escape {{ .data.theme.colors.accent }}
set -g fish_color_operator {{ .data.theme.colors.accent }}
set -g fish_color_end {{ .data.theme.colors.accent }}
set -g fish_color_quote aaaaaa
set -g fish_color_autosuggestion 555555
set -g fish_color_valid_path --underline
set -g fish_color_cwd {{ .data.theme.colors.accent }}
set -g fish_color_cwd_root red
set -g fish_color_match --background=brblue
set -g fish_color_search_match bryellow --background=brblack
set -g fish_color_selection white --bold --background=brblack
set -g fish_color_cancel -r
set -g fish_color_history_current --bold

# Set up terminal integration based on terminal
if test "$TERM_PROGRAM" = "iTerm.app"
    set -g iterm2_hostname "{{ .data.name }}@$(hostname)"
end
EOF

# Only replace the file if it changed
if ! cmp -s ~/.config/fish/conf.d/theme.fish.tmp ~/.config/fish/conf.d/theme.fish; then
    mv ~/.config/fish/conf.d/theme.fish.tmp ~/.config/fish/conf.d/theme.fish
else
    rm ~/.config/fish/conf.d/theme.fish.tmp
fi

echo "Fish shell setup complete."
